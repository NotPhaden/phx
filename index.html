<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard - PHX</title>
<link rel="icon" type="image/png" href="logo.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0b0b;
  --card:#1f1b24;
  --muted:#a9a4b1;
  --accent:#6f4bd8;
  font-family: 'Inter', system-ui;
}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;background:var(--bg);color:#e9e8ee;}
.app{display:flex;min-height:100vh;}
.sidebar{width:260px;background:linear-gradient(180deg,#0f0e10 0%, #1b1620 100%);padding:24px 18px;border-right:1px solid rgba(255,255,255,0.02);}
.logo{display:flex;align-items:center;margin-bottom:18px;}
.logo img{width:40px;height:40px;margin-right:10px;}
.logo span{font-weight:800;color:#cfc7ff;font-size:16px;letter-spacing:1px;}
.menu{margin-top:12px;}
.menu a{display:block;padding:12px 10px;border-radius:10px;color:var(--muted);text-decoration:none;margin-bottom:6px;}
.menu a.active{background:linear-gradient(90deg,var(--accent),#3b2aa3);color:#fff;}
.menu .section-title{font-size:12px;color:var(--muted);text-transform:uppercase;margin:18px 0 8px;}
.main{flex:1;padding:30px 36px;overflow:auto;position:relative;}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
.header h1{margin:0;font-size:22px;}
.user-profile{display:flex;align-items:center;cursor:pointer;}
.user-profile img{width:60px;height:60px;border-radius:50%;margin-right:12px;object-fit:cover;}
.user-profile span{font-weight:700;color:#fff;font-size:18px;}
.grid{display:grid;grid-template-columns:repeat(12,1fr);grid-gap:18px;margin-top:18px;}
.status-card, .players-card {background:var(--card);border-radius:14px;padding:20px;border:1px solid rgba(255,255,255,0.03);min-height:160px;display:flex;flex-direction:column;justify-content:center;grid-column:span 4;position:relative;overflow:hidden;}
.icon-box{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:12px;}
.status-card .icon-box{background:rgba(0,255,100,0.15);}
.players-card .icon-box{background:rgba(120,140,255,0.15);}
.status-big{font-size:20px;font-weight:700;margin-bottom:4px;}
.small-text{color:var(--muted);font-size:13px;}
.dot{width:10px;height:10px;border-radius:50%;position:absolute;right:16px;top:16px;}
.card{background:var(--card);border-radius:14px;padding:20px;display:flex;flex-direction:column;justify-content:center;border:1px solid rgba(255,255,255,0.03);min-height:160px;}
.stat{grid-column:span 4;}
.stat .title{font-size:13px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;}
.stat .value{font-weight:700;font-size:20px;margin-bottom:6px;}
.connect-btn{display:inline-block;margin-top:6px;padding:8px 16px;background:linear-gradient(90deg,#6f4bd8,#3b2aa3);color:#fff;text-decoration:none;border-radius:8px;font-weight:600;transition:0.3s;text-align:center;}
.connect-btn:hover{background:linear-gradient(90deg,#3b2aa3,#6f4bd8);}
.server-feed{grid-column:span 5;}
.top-players{grid-column:span 3;}
.player-item{display:flex;align-items:center;margin-top:12px;padding:8px;background:rgba(255,255,255,0.03);border-radius:10px;}
.player-item img.avatar{width:50px;height:50px;border-radius:50%;margin-right:12px;object-fit:cover;}
.player-item .info{display:flex;flex-direction:column;}
.player-item .info .name{font-weight:700;font-size:14px;}
.player-item .info .hours{font-size:12px;color:#7d7a89;}
@media(max-width:960px){.sidebar{display:none;}.grid{grid-template-columns:repeat(6,1fr);}.status-card,.players-card,.stat,.server-feed,.top-players{grid-column:span 6;}}

#loadingScreen {position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:2000;color:#fff;font-size:20px;animation:fadein 1s ease;}
#loadingScreen img {width:120px;height:120px;margin-bottom:20px;animation:spin 2s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
@keyframes fadein{0%{opacity:0;}100%{opacity:1;}}

#loginContainer {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:none;justify-content:center;align-items:center;z-index:1000;flex-direction:column;}
#loginContainer input {width:320px;max-width:90%;margin-bottom:12px;padding:10px;border-radius:8px;border:none;background:#1f1b24;color:#fff;}
#loginContainer button {width:320px;max-width:90%;padding:10px;background:linear-gradient(90deg,#6f4bd8,#3b2aa3);color:#fff;border:none;border-radius:8px;font-weight:600;margin-bottom:8px;cursor:pointer;}
#loginContainer p {font-size:12px;color:red;margin-top:4px;text-align:center;}

#profileOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:none;justify-content:center;align-items:center;z-index:1500;}
#profileOverlay div{background:#1f1b24;padding:30px;border-radius:14px;width:350px;text-align:center;}
#profileOverlay input{width:100%;margin-bottom:12px;padding:10px;border-radius:8px;border:none;background:#0f0e10;color:#fff;}
#profileOverlay button{width:100%;padding:10px;background:linear-gradient(90deg,#6f4bd8,#3b2aa3);color:#fff;border:none;border-radius:8px;font-weight:600;margin-bottom:8px;cursor:pointer;}
#profileOverlay p{font-size:13px;color:lightgreen;margin-top:6px;}
</style>
</head>
<body>

<div id="loadingScreen">
  <img src="logo.png" alt="Logo">
  <div>Loading...</div>
</div>

<div id="loginContainer">
  <div>
    <h2>Autentificare / √énregistrare</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="ParolƒÉ">
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
    <p id="loginError"></p>
  </div>
</div>

<div id="profileOverlay">
  <div>
    <h2>Profilul Meu</h2>
    <input type="text" id="profileName" placeholder="Nume">
    <input type="text" id="profileID" placeholder="ID Server">
    <input type="text" id="profileAvatar" placeholder="URL PozƒÉ Profil">
    <button id="saveProfileBtn">SalveazƒÉ Profil</button>
    <button id="closeProfileBtn">√énchide</button>
    <p id="profileMessage"></p>
  </div>
</div>

<div class="app" style="display:none;">
  <aside class="sidebar">
    <div class="logo">
      <img src="logo.png" alt="PHX Logo">
      <span>PHX ROMANIA ROLEPLAY</span>
    </div>
    <div class="menu">
      <div class="section-title">Menu</div>
      <a class="active" href="index.html">Home</a>
      <a href="https://discord.gg/vUtd9JCypQ" target="_blank">Discord</a>
      <a href="staff.html">Staff</a>
      <a href="factiuni.html">Factiuni</a>
      <a href="shop.html">Shop</a>
      <a href="tickets.html">Tickets</a>
      <a href="#" id="logoutBtn">Logout</a>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <h1>Dashboard</h1>
      <div class="user-profile" id="profileMenuBtn">
        <img src="logo.png" id="headerAvatar" alt="Avatar">
        <span id="headerName">User</span>
      </div>
    </div>

    <div class="grid">
      <div class="status-card">
        <div class="icon-box">üñ•Ô∏è</div>
        <div class="dot" id="statusDot"></div>
        <div class="status-big" id="serverStatusText">Loading...</div>
        <div class="small-text">Server Status</div>
      </div>

      <div class="players-card">
        <div class="icon-box">üë•</div>
        <div class="status-big" id="onlinePlayers">Loading...</div>
        <div class="small-text">Online Players</div>
      </div>

      <div class="stat card">
        <div class="title">Vehicule pe server</div>
        <div class="value">39</div>
      </div>

      <div class="stat card">
        <div class="title">Eveniment Activ</div>
        <div class="value">Colinde de CrƒÉciun</div>
        <p style="font-size:13px;color:#a9a4b1;margin:6px 0 0;">
          üéÑ SƒÉrbƒÉtore»ôte CrƒÉciunul pe PHX! Mergi prin ora»ô »ôi colindƒÉ casele pentru <strong>recompense festive</strong> »ôi surprize speciale! üéÅ‚ú®
        </p>
      </div>

      <div class="card server-feed">
        <h3>Bun venit pe PHX!</h3>
        <p>Bine ai venit pe serverul nostru! üèÜ<br>
           - VerificƒÉ periodic jucƒÉtorii online »ôi vehiculele.<br>
           - RespectƒÉ regulile serverului.<br>
           - Fii activ »ôi respectuos √Æn comunitate.</p>
      </div>

      <div class="card top-players">
        <h3 style="margin-top:0">Top 3 JucƒÉtori</h3>
        <div class="player-item">
          <img class="avatar" src="https://media.discordapp.net/attachments/1153942954650648657/1442168936501215283/NTc5MjQxMS5qcGc.png" alt="PHX">
          <div class="info">
            <span class="name">1</span>
            <span class="hours">Hours played: - </span>
          </div>
        </div>
        <div class="player-item">
          <img class="avatar" src="https://media.discordapp.net/attachments/1153942954650648657/1442168936501215283/NTc5MjQxMS5qcGc.png" alt="AAA">
          <div class="info">
            <span class="name">2</span>
            <span class="hours">Hours played: - </span>
          </div>
        </div>
        <div class="player-item">
          <img class="avatar" src="https://media.discordapp.net/attachments/1153942954650648657/1442168936501215283/NTc5MjQxMS5qcGc.png" alt="BBB">
          <div class="info">
            <span class="name">3</span>
            <span class="hours">Hours played: - </span>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<script type="module">
/* -----------------------
   Firebase + App Logic
   ----------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCNmtNk-qgYbTBFtz-fvT4lqCiKaUhIwZU",
  authDomain: "phxrp-a6554.firebaseapp.com",
  projectId: "phxrp-a6554",
  storageBucket: "phxrp-a6554.firebasestorage.app",
  messagingSenderId: "413786501080",
  appId: "1:413786501080:web:34a391f66e58acc45a8cad",
  measurementId: "G-K935NMKEZL"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* UI elements */
const loadingScreen = document.getElementById("loadingScreen");
const loginContainer = document.getElementById("loginContainer");
const loginBtn = document.getElementById("loginBtn");
const registerBtn = document.getElementById("registerBtn");
const loginError = document.getElementById("loginError");
const appContainer = document.querySelector(".app");

const profileOverlay = document.getElementById("profileOverlay");
const profileName = document.getElementById("profileName");
const profileID = document.getElementById("profileID");
const profileAvatar = document.getElementById("profileAvatar");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const closeProfileBtn = document.getElementById("closeProfileBtn");
const profileMessage = document.getElementById("profileMessage");
const profileMenuBtn = document.getElementById("profileMenuBtn");
const logoutBtn = document.getElementById("logoutBtn");
const headerName = document.getElementById("headerName");
const headerAvatar = document.getElementById("headerAvatar");

const serverStatusText = document.getElementById("serverStatusText");
const statusDot = document.getElementById("statusDot");
const onlinePlayers = document.getElementById("onlinePlayers");

/* Show loading then login */
setTimeout(()=>{
  loadingScreen.style.display="none";
  loginContainer.style.display="flex";
},500);

/* LOGIN */
loginBtn.addEventListener("click", ()=>{
  const emailVal = document.getElementById("email").value.trim();
  const passwordVal = document.getElementById("password").value;
  if(!emailVal || !passwordVal){ loginError.textContent = "CompleteazƒÉ email »ôi parolƒÉ."; return; }

  signInWithEmailAndPassword(auth,emailVal,passwordVal)
  .then(userCredential=>{
    loginError.textContent="";
    // onAuthStateChanged will handle UI
  })
  .catch(error=>{loginError.textContent=error.message;});
});

/* REGISTER */
registerBtn.addEventListener("click", ()=>{
  const emailVal = document.getElementById("email").value.trim();
  const passwordVal = document.getElementById("password").value;
  if(!emailVal || !passwordVal){ loginError.textContent = "CompleteazƒÉ email »ôi parolƒÉ."; return; }

  createUserWithEmailAndPassword(auth,emailVal,passwordVal)
  .then(userCredential=>{
    // create default user node
    set(ref(db,"users/"+userCredential.user.uid),{
      name:"", avatar:"", serverID:"", email:emailVal
    });
    loginError.textContent="";
  })
  .catch(error=>{loginError.textContent=error.message;});
});

/* AUTH STATE */
onAuthStateChanged(auth,user=>{
  if(user){
    loginContainer.style.display="none";
    appContainer.style.display="flex";
    loadProfileData(user.uid);
  }else{
    appContainer.style.display="none";
    loginContainer.style.display="flex";
  }
});

/* LOGOUT */
logoutBtn.addEventListener("click", ()=>{ signOut(auth); });

/* PROFILE OVERLAY */
profileMenuBtn.addEventListener("click", ()=>{ profileOverlay.style.display="flex"; });
closeProfileBtn.addEventListener("click", ()=>{ profileOverlay.style.display="none"; });

/* SAVE PROFILE
   Important: we DO NOT force a default "logo.png" into DB when input is empty.
   If input is empty, DB will be set to empty string (meaning no custom avatar).
*/
saveProfileBtn.addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  const nameVal = profileName.value.trim();
  const avatarVal = profileAvatar.value.trim(); // can be empty
  const idVal = profileID.value.trim();

  // Save exactly what user typed (even empty avatar allowed)
  await set(ref(db,"users/"+user.uid),{
    name: nameVal,
    avatar: avatarVal,
    serverID: idVal,
    email: user.email
  });

  // Update UI immediately
  headerName.textContent = nameVal || user.email;
  headerAvatar.src = avatarVal ? avatarVal : "logo.png";

  profileMessage.textContent="Profil salvat!";
  setTimeout(()=>{ profileMessage.textContent=""; profileOverlay.style.display="none"; },1400);
});

/* LOAD PROFILE DATA
   Key fixes:
   - Do NOT put "logo.png" into the profileAvatar input when avatar is missing.
   - Only use "logo.png" as display fallback for headerAvatar.src.
*/
function loadProfileData(uid){
  get(ref(db,"users/"+uid)).then(snapshot=>{
    if(snapshot.exists()){
      const data=snapshot.val();
      profileName.value = data.name || "";
      profileID.value = data.serverID || "";
      // IMPORTANT: keep input empty when avatar not set
      profileAvatar.value = data.avatar || "";
      headerName.textContent = data.name || data.email || "User";
      headerAvatar.src = (data.avatar && data.avatar.trim() !== "") ? data.avatar : "logo.png";
      profileMessage.textContent = "";
    } else {
      // No node yet ‚Äî keep defaults
      profileName.value = "";
      profileID.value = "";
      profileAvatar.value = "";
      headerName.textContent = auth.currentUser?.email || "User";
      headerAvatar.src = "logo.png";
    }
  }).catch(err=>{
    console.error("loadProfileData error:",err);
  });
}

/* SERVER DATA (FiveM API) */
async function updateServerData(){
  try{
    const res = await fetch("https://servers-frontend.fivem.net/api/servers/single/vz8zjk");
    const data = await res.json();
    const isOnline = !!data?.Data;
    const players = data?.Data?.clients ?? 0;
    const maxPlayers = data?.Data?.sv_maxclients ?? 0;

    onlinePlayers.textContent = players + "/" + maxPlayers;
    if(isOnline){
      serverStatusText.textContent="Operational";
      statusDot.style.background="#45ff65";
    }else{
      serverStatusText.textContent="Offline";
      statusDot.style.background="red";
    }
  }catch(e){
    onlinePlayers.textContent="N/A";
    serverStatusText.textContent="Offline";
    statusDot.style.background="red";
    console.warn("updateServerData failed:", e);
  }
}
updateServerData();
setInterval(updateServerData,8000);

</script>
</body>
</html>
